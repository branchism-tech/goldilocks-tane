<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-T4VP8W27PL"
    ></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>キュリオグラフ｜壁面ディスプレイ</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet"
    />

    <style>
      :root {
        --gap: 14px;
        --side-pad: 18px;
        --card-radius: 18px;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        --vline: #e5e5e5;
        /* Material Design 3 color tokens */
        --md-sys-color-primary: #2a51b3;
        --md-sys-color-on-primary: #ffffff;
        --md-sys-color-primary-container: #f9f4ee;
        --md-sys-color-on-primary-container: #21005d;
        --md-sys-color-secondary: #757575;
        --md-sys-color-on-secondary: #ffffff;
        --md-sys-color-secondary-container: #e8def8;
        --md-sys-color-on-secondary-container: #1d192b;
        --md-sys-color-hada: #f3e9df;
        --md-sys-color-yellow: #efc800;
        --md-sys-color-red: #e60312;
        --md-sys-color-orange: #ed0300;
        --md-sys-color-green: #268454;
        --md-sys-color-surface: #fff;
        --md-sys-color-blue: #afccd1;
        --md-sys-color-on-surface: #1d1b20;
        --md-sys-color-surface-variant: #ebebeb;
        --md-sys-color-on-surface-variant: #525252;
        --md-sys-color-outline: #7a7a7a;
        --md-sys-color-outline-variant: #cac4d0;
        --md-sys-color-error: #e60312;
        --md-sys-color-on-error: #ffffff;
        --md-sys-color-error-container: #ffdad6;
        --md-sys-color-on-error-container: #410002;

        /* Elevation tokens */
        --md-sys-elevation-level0: 0px 1px 2px 0px rgba(0, 0, 0, 0.2),
          0px 1px 3px 1px rgba(0, 0, 0, 0.1);
        --md-sys-elevation-level1: 0px 1px 2px 0px rgba(0, 0, 0, 0.3),
          0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        --md-sys-elevation-level2: 0px 1px 2px 0px rgba(0, 0, 0, 0.3),
          0px 2px 6px 2px rgba(0, 0, 0, 0.15);
        --md-sys-elevation-level3: 0px 1px 3px 0px rgba(0, 0, 0, 0.3),
          0px 4px 8px 3px rgba(0, 0, 0, 0.15);

        /* Shape tokens */
        --md-sys-shape-corner-extra-small: 4px;
        --md-sys-shape-corner-small: 8px;
        --md-sys-shape-corner-medium: 12px;
        --md-sys-shape-corner-large: 16px;
        --md-sys-shape-corner-extra-large: 28px;
      }

      /* 全面背景にGIFをベタ貼り */
      body {
        margin: 0;
        height: 100vh;
        overflow: hidden; /* スクロールバーは出さない */
        background: #000 url("./monitor.gif") center/100% 100% no-repeat fixed;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic",
          "Helvetica Neue", Arial, sans-serif;
        color: #111;
      }

      /* 7:3 レイアウト */
      .shell {
        display: grid;
        grid-template-columns: 7fr 3fr; /* 7:3 */
        gap: var(--gap);
        height: 100vh;
        padding: var(--gap);
        box-sizing: border-box;
      }

      /* 左は背景だけ */
      .left {
        position: relative;
      }

      /* 右パネル（白カード） */
      .right {
        background: transparent;
        border-radius: var(--card-radius);
        box-shadow: none;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
      }
      .right .header {
        position: absolute;
        top: 25%; /* 上から25%に配置 */
        width: 100%;
        text-align: center;
      }
      .header {
        margin-top: 3px;
        padding: 7px 9px 4px 9px;
      }
      .header .title {
        font-weight: 800;
        font-size: clamp(16px, 16px, 16px);
        letter-spacing: 0.02em;
      }
      .right .stage {
        padding-top: 28vh; /* ヘッダーの高さ */
      }

      /* 表示エリア（一覧 or 詳細）を切替 */
      .stage {
        flex: 1 1 auto;
        min-height: 0; /* グリッド領域内で縮むために必要 */
        padding: var(--side-pad);
        display: flex;
        flex-direction: column;
        gap: var(--gap);
        overflow: hidden; /* スクロールバーを出さない */
      }

      /* ===== 一覧（テーブル非使用のグリッド） ===== */
      .listWrap {
        display: flex;
        flex-direction: column;
        gap: 5px;
        overflow: hidden; /* スクロールバー無し */
      }

      /* ヘッダー */
      .headGrid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 3px 5px;
        align-items: start;
        overflow: hidden;
        font-size: clamp(12px, 12px, 12px);
        border-bottom: 0.5px solid #eee;
      }
      .headGrid > div {
        padding: 0.5px 0.5px;
      }

      /* データ本体 */
      #listGrid {
        display: flex;
        flex-direction: column;
        gap: 0; /* 列間の余白は .gridRow 内の gap で調整 */
        overflow: hidden;
      }

      /* 1行：4等分グリッド。行そのものに横線を引く */
      #listGrid .gridRow {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1px 1px; /* 列間の余白 */
        align-items: start;
        padding: 1px 1px; /* 行の上下左右パディング */
        border-bottom: 0.5px solid #f2f2f2; /* 横の罫線は“行”に一本だけ */
      }
      /* 1行=4セルを素直に流す */
      #listGrid .item {
        display: contents;
      }

      /* 共通セル */
      #listGrid .cell {
        line-height: 1.1;
        white-space: pre-wrap;
        overflow: visible;
        font-size: 8px;
      }
      #listGrid .cell:first-child {
        display: flex;
        align-items: center; /* 縦中央揃え */
        gap: 8px;
      }
      /* コメントは最大3行まで綺麗に折返し表示 */
      #listGrid .cell.comment {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3; /* 3〜5 などに調整可 */
        line-clamp: 3; /* 3〜5 などに調整可 */
        overflow: hidden;
      }

      /* いいね（ハート赤、数字黒） */
      #listGrid .cell.like {
        text-align: center;
        font-variant-numeric: tabular-nums;
      }
      .like .heart {
        color: #f54e2e;
        margin-right: 0.35em;
        font-weight: 800;
      }
      .like .num {
        color: #000;
      }
      /* 一覧側も透過 */
      .stage,
      .listWrap,
      .headGrid,
      #listGrid .cell {
        background: transparent;
      }
      .avatar1 {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 2px;
      }

      /* ===== 詳細カード（Top3を順番表示） ===== */
      .card-like {
        width: 100%;
        margin: 0;
        background-color: var(--md-sys-color-surface);
        padding: 14px 10px;
        box-sizing: border-box;
        border-radius: var(--md-sys-shape-corner-large);
        box-shadow: var(--md-sys-elevation-level1);
        margin: 0 auto;
      }
      .seed-title-wrap {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin: 24px 0;
      }
      .avatar2 {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: var(--md-sys-elevation-level1);
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .field-label {
        font-weight: 900;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.1px;
        color: var(--md-sys-color-on-surface-variant);
        margin-top: 16px;
        margin-bottom: 8;
        text-transform: uppercase;
      }

      .field-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
        padding: 12px 16px;
        background-color: var(--md-sys-color-surface-variant);
        border-radius: var(--md-sys-shape-corner-small);
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
      }

      .field-label-2 {
        font-weight: 500;
        font-size: 12px;
        line-height: 20px;
        letter-spacing: 0.1px;
        color: var(--md-sys-color-on-surface-variant);
        min-width: 160px;
        margin-top: 16px;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .category-row {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      #categoryText {
        font-size: 12px;
        line-height: 16px;
        color: var(--md-sys-color-on-surface);
        font-weight: 500;
        letter-spacing: 0.4px;
        padding: 8px 16px;
        background-color: #efefef;
        border-radius: var(--md-sys-shape-corner-extra-large);
      }

      #categoryText-2 {
        font-size: 10px;
        color: var(--md-sys-color-on-surface-variant);
        display: inline;
        margin-left: 2px;
      }

      #titleText {
        font-size: 24px !important;
        font-weight: 900 !important;
        line-height: 32px;
        color: var(--md-sys-color-on-surface);
        padding: 8px 0;
      }

      #commentText {
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
        white-space: pre-wrap;
      }

      #kindText {
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
        white-space: pre-wrap;
      }

      /* いいね！ */
      .likes-header {
        display: flex;
        align-items: baseline;
        gap: 6px;
      }

      .likes-title {
        font-weight: 900;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.1px;
        color: var(--md-sys-color-on-surface-variant);
        margin-top: 8px;
        margin-bottom: 16px;
        text-transform: uppercase;
      }

      .likes-avatars {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 12px;
        margin-bottom: 24px;
      }

      .likes-avatars img {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: var(--md-sys-elevation-level1);
        transition: transform 0.2s ease;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="left"></div>

      <div class="right">
        <div class="header">
          <div class="title" id="viewTitle">最新タネ一覧</div>
        </div>

        <div class="stage">
          <!-- 一覧ビュー -->
          <div class="listWrap" id="listView" style="display: block">
            <div class="headGrid">
              <div>投稿者</div>
              <div>タイトル</div>
              <div>コメント</div>
              <div>いいね数</div>
            </div>
            <div id="listGrid"></div>
          </div>

          <!-- 詳細ビュー -->
          <div class="card-like" id="detailView" style="display: none">
            <div class="mb-2 category-row">
              <div id="categoryText">読み込み中・・</div>
              <div id="categoryText-2">読み込み中・・</div>
            </div>

            <div id="titleText">読み込み中・・</div>

            <div class="seed-title-wrap">
              <img id="ownerIcon" class="avatar2" src="logo.png" alt="owner" />
              <div id="ownerName">読み込み中・・</div>
            </div>

            <div class="field-label">投稿者コメント</div>
            <div id="commentText">読み込み中・・</div>

            <div class="field-label">こんな人にきて欲しい、集まれ！</div>
            <div id="kindText">読み込み中・・</div>

            <hr />

            <div class="likes-header">
              <div class="likes-title">いいね！</div>
            </div>

            <div id="likesAvatars" class="likes-avatars"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay">
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      ></div>
    </div>

    <div id="errToast"><span id="errText"></span></div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="./utils.js?ver=1.03"></script>
    <script>
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzAno1Dw2ikstvC9exjQyYLs3X8K_st48GGXooE8SqqcTuMNq6H_M4jW8E5CDlphN0-cg/exec";
      const DUMMY_ICON_URL = "logo.png";

      function toast(msg) {
        $("#errToast").text(msg).fadeIn(200);
        setTimeout(() => $("#errToast").fadeOut(300), 2000);
      }

      async function fetchTanes() {
        const idt = "";
        const url = `${GAS_ENDPOINT}?action=tane_list_all_for_event_dsp`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "fail");
        return j.list;
      }

      const sortByCreatedDesc = (a, b) =>
        new Date(b.createdAt) - new Date(a.createdAt);
      const escapeHTML = (s) =>
        String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");

      // 速度を速くするため、サーバー側では、top3のみ、いいねデータを作っている。
      function topLikes(arr, n) {
        return arr
          .filter((r) => r.top3)
          .sort((a, b) => {
            const likeDiff =
              (Number(b.likeCount) || 0) - (Number(a.likeCount) || 0);
            if (likeDiff !== 0) return likeDiff;
            return new Date(b.createdAt) - new Date(a.createdAt);
          })
          .slice(0, n);
      }

      /** ========== 状態 ========== */
      const state = {
        all: [],
        top3: [],
      };

      /** ========== 描画 ========== */

      /* 一覧（新着順 上位25件） */
      function renderListGrid(snapshot) {
        const host = document.getElementById("listGrid");
        const top25 = [...snapshot].sort(sortByCreatedDesc).slice(0, 25);

        const html = top25
          .map(
            (r) => `
          <div class="gridRow">
            <div class="cell">
              <img class="avatar1"
                    src="${r.ownerIcon || DUMMY_ICON_URL}"
                    loading="lazy"
                    referrerpolicy="no-referrer"
                    onerror="this.onerror=null; this.src='logo.png';"/>
              <div>${escapeHTML(r.name) || "名無し"}</div>
            </div>
            <div class="cell title">${escapeHTML(r.title || "")}</div>
            <div class="cell comment">${escapeHTML(r.comment || "")}</div>
            <div class="cell like"><span class="heart">❤</span><span class="num">${Number(
              r.likeCount || 0
            )}</span></div>
          </div>
        `
          )
          .join("");

        host.innerHTML = html;
      }

      function renderLikes(list) {
        const wrap = document.getElementById("likesAvatars");
        if (!wrap) return;

        wrap.innerHTML = "";

        (list || []).forEach((x, i) => {
          const img = document.createElement("img");
          const idNum = String(i + 1).padStart(3, "0");
          const domId = `likesAvatar_${idNum}`;

          img.id = domId;
          img.src =
            (x.likeProfile && x.likeProfile.ownerIcon) || DUMMY_ICON_URL;
          img.alt = "like-user";
          img.loading = "lazy";
          img.referrerPolicy = "no-referrer";
          img.onerror = () => {
            img.onerror = null;
            img.src = DUMMY_ICON_URL; // 404などで失敗したときはロゴに切替
          };
          wrap.appendChild(img);
        });
      }

      /* 詳細（Top3を順番に） */
      function renderDetailCard(item, rankIndex) {
        // 本体表示
        const categoryLabel = item.category || "";
        const theme1 = categoryLabel.substring(0, 4);
        const theme2 = categoryLabel.substring(4);

        $("#categoryText").text(`${theme1}`);
        $("#categoryText-2").text(`${theme2}`);

        $("#titleText").text(item.title || "");
        $("#commentText").text(item.comment || "");
        $("#kindText").text(item.kind_person || "");
        $("#ownerIcon")
          .attr("src", item.ownerIcon || DUMMY_ICON_URL)
          .attr("loading", "lazy")
          .attr("referrerpolicy", "no-referrer")
          .on("error", function () {
            $(this).off("error").attr("src", DUMMY_ICON_URL);
          });
        $("#ownerName").text(item.name || "");

        // いいね一覧
        renderLikes(item.likes || []);
      }

      /** ========== 表示切替のローテーション ========== */
      let cycleTimer = null;

      function showList(snapshot) {
        // タイトル切り替え
        document.getElementById("viewTitle").textContent = "最新タネ一覧";

        // 表示切替
        document.getElementById("listView").style.display = "block";
        document.getElementById("detailView").style.display = "none";

        renderListGrid(snapshot);
      }

      function showDetail(snapshotTop3, idx) {
        if (!snapshotTop3[idx]) return;
        document.getElementById("viewTitle").textContent = "いいねが多いタネ";

        document.getElementById("listView").style.display = "none";
        document.getElementById("detailView").style.display = "block";

        renderDetailCard(snapshotTop3[idx], idx);
      }

      function startCycle() {
        if (cycleTimer) {
          clearTimeout(cycleTimer);
          cycleTimer = null;
        }

        // スナップショットを確定（描画中にstateが更新されても影響しない）
        const snapAll = [...state.all];
        const snapTop3 = [...state.top3];

        // 0) 一覧 30秒
        showList(snapAll);
        cycleTimer = setTimeout(() => {
          // 1) Top1 10秒
          showDetail(snapTop3, 0);
          cycleTimer = setTimeout(() => {
            // 2) Top2 10秒
            showDetail(snapTop3, 1);
            cycleTimer = setTimeout(() => {
              // 3) Top3 10秒 → ループ
              showDetail(snapTop3, 2);
              cycleTimer = setTimeout(() => {
                startCycle(); // 再帰ループ
              }, 10 * 1000);
            }, 10 * 1000);
          }, 10 * 1000);
        }, 30 * 1000);
      }

      /** ========== 起動と定期更新 ========== */
      function boot() {
        const POLL_MS = 60 * 1000; // 1分ごと

        let pollTimer = null;

        async function pollData() {
          try {
            const fresh = await fetchTanes();
            if (Array.isArray(fresh) && fresh.length) {
              state.all = [...fresh].sort(sortByCreatedDesc);
              state.top3 = topLikes(state.all, 3);
              // 次のサイクルで自動的に最新スナップショットが表示される
            }
          } catch (e) {
            // ネットワーク一時エラーなどは握りつぶす
            // console.warn(e);
          } finally {
            // 前回処理が完全に終わってから次回予約
            pollTimer = setTimeout(pollData, POLL_MS);
          }
        }

        (async () => {
          try {
            // 初回ロード
            const initial = await fetchTanes();
            state.all = [...initial].sort(sortByCreatedDesc);
            state.top3 = topLikes(state.all, 3);

            // 画面ローテーション開始
            startCycle();
          } catch (e) {
            toast("読み込み失敗");
          } finally {
            // 初回描画後にポーリング開始
            pollData();
          }
        })();
      }

      boot();
    </script>
  </body>
</html>
