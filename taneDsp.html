<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タネをみる</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    />

    <style>
      body {
        background: #f4efe8;
      }
      .card-like {
        max-width: 560px;
        margin: 0 auto 48px;
        background: #f3e8d7;
        border: 2px solid #8f816e;
        border-radius: 4px;
        padding: 16px 16px 24px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 4px 0 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #bcad97;
      }
      .brand .logo { width: 30px; height: 30px; display: inline-block; }
      .section-title { font-weight: 700; font-size: 22px; padding-bottom: 8px; margin: 8px 0 16px; }

      .seed-title-wrap { display: flex; align-items: center; gap: 12px; }
      .avatar { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #aaa; object-fit: cover; }

      .field-label { font-weight: 700; margin-top: 12px; margin-bottom: 6px; }

      /* いいね！ */
      .likes-header { display: flex; align-items: baseline; gap: 8px; margin: 10px 0 6px; }
      .likes-title { font-weight: 700; }
      .likes-count { color: #666; font-size: 13px; }

      .likes-avatars {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 12px;
      }
      .likes-avatars img {
        width: 36px; height: 36px; object-fit: cover;
        border-radius: 50%;
        border: 1px solid #ccc;
      }

      .like-btn-row { display: flex; justify-content: flex-end; }
      .like-btn { min-width: 120px; }
      .like-btn[disabled] { background: #adb5bd; border-color: #adb5bd; cursor: default; }
      .btn-liked { pointer-events: none; opacity: 0.8; }

      .hint { color: #666; font-size: 12px; }

      /* オーバーレイ／トースト */
      #loadingOverlay {
        position: fixed; inset: 0; background: rgba(255,255,255,0.85);
        z-index: 1050; display: none; justify-content: center; align-items: center;
      }
      #errToast {
        display: none; position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
        background: #222; color: #fff; padding: 10px 14px; border-radius: 6px; z-index: 1100;
      }
    </style>
  </head>
  <body>
    <div class="card-like">
      <div class="brand">
        <img class="logo" src="logo.png" alt="キュリオグラフ2025" />
        <strong>キュリオグラフ2025</strong>
      </div>

      <div class="hint mb-2" id="categoryText">カテゴリ</div>
      <div id="titleText" style="font-size: 20px; font-weight: 700">
        タイトル
      </div>

      <div class="seed-title-wrap my-2">
        <img id="ownerIcon" class="avatar" src="smile.png" alt="owner" />
      </div>

      <div class="field-label">コメント</div>
      <div id="commentText">…</div>

      <div class="field-label">きて欲しい人</div>
      <div id="kindText" >…</div>

      <hr />

      <div class="likes-header">
        <div class="likes-title">いいね！</div>
      </div>

      <div id="likesAvatars" class="likes-avatars"></div>

      <div class="like-btn-row">
        <button id="likeBtn" class="btn btn-primary like-btn">いいね！</button>
      </div>

    <!-- ローディングオーバーレイ -->
    <div
      id="loadingOverlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 1050;
        display: flex;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <div id="errToast"><span id="errText"></span></div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="./utils.js?ver=1.00"></script>

    <script>
      var debugTxt = "最初=" + formatNow() + "\n";
      // ===== 設定 =====
      const LIFF_ID = "2008071727-prQWbK4R";
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzAno1Dw2ikstvC9exjQyYLs3X8K_st48GGXooE8SqqcTuMNq6H_M4jW8E5CDlphN0-cg/exec";
      const DUMMY_ICON_URL = 'https://placehold.jp/40x40.png?text=DUMMY';

      const taneId = new URL(location.href).searchParams.get("taneId");

      function renderLikes(list) {
        // list: [{userId, iconUrl, createdAt}, ...] 作成日順
        const wrap = document.getElementById('likesAvatars');
        wrap.innerHTML = '';
        (list || []).forEach(x => {
          const img = document.createElement('img');
          img.src = x.iconUrl || DUMMY_ICON_URL;
          img.alt = 'like-user';
          wrap.appendChild(img);
        });
      }

      function setLiked() {
        const btn = document.getElementById('likeBtn');
        btn.textContent = 'いいね済み';
        btn.disabled = true;
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      }

      async function loadPage() {
         debugTxt += "loadPage start=" + formatNow() + "\n";
        if (!taneId) {
          toast("taneId がありません");
          return;
        }
        loading.on();
        try {
          const idToken = liff.getIDToken();
         debugTxt += "loadPage idToken後=" + formatNow() + "\n";

          const r = await fetch(
            `${GAS_ENDPOINT}?action=tane_public_bundle&taneId=${encodeURIComponent(
              taneId
            )}&id_token=${encodeURIComponent(idToken)}`
          );
         debugTxt += "loadPage fetch後=" + formatNow() + "\n";

          const j = r.ok ? await r.json() : { ok: false };
          if (!j.ok || !j.record) {
            toast(j.error || "タネが見つかりません");
            return;
          }

          // 本体
          $("#categoryText").text(`カテゴリ：${j.record.category || ""}`);
          $("#titleText").text(j.record.title || "");
          $("#commentText").text(j.record.comment || "");
          $("#kindText").text(j.record.kind_person || "");
          $("#ownerIcon").attr("src", j.ownerIcon || DUMMY_ICON_URL);

          renderLikes(j.likes || []);
          if (j.alreadyLiked) setLiked();
          debugTxt += "loadPage end=" + formatNow() + "\n";

        } catch (e) {
          console.error(e);
          toast("読み込みエラーが発生しました");
        } finally {
          loading.off();
        }
      }

      async function likeAction() {
        if ($("#likeBtn").hasClass("btn-liked")) return;
        loading.on();
        try {
          const idt = liff.getIDToken();
          const r = await fetch(
            `${GAS_ENDPOINT}?action=like_tane&taneId=${encodeURIComponent(
              taneId
            )}&id_token=${encodeURIComponent(idt)}`
          );
          const j = r.ok ? await r.json() : { ok: false };
          if (!j.ok) {
            toast(j.error || "いいねに失敗しました");
            return;
          }
          setLiked();
          renderLikes(j.list || []);
        } catch (e) {
          console.error(e);
          toast("いいね処理でエラー");
        } finally {
          loading.off();
        }
      }

     $(async function () {
        try {
          debugTxt += "async function () start=" + formatNow() + "\n";
          await liff.init({ liffId: LIFF_ID });
          debugTxt += "async function () liff.init後=" + formatNow() + "\n";
          const ready = await  ensureLoginAndScopes();
          debugTxt += "async function () ensureLoginAndScopes後=" + formatNow() + "\n";
          if (!ready) return;
          await loadPage();
          $("#likeBtn").on("click", likeAction);
          // alert(debugTxt);

        } catch (e) {
          console.error("LIFF init failed", e);
          showErrorAndClose("LIFFの初期化に失敗しました");
        }
      });
    </script>
  </body>
</html>
