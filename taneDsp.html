<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>タネをみる</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Material Design 3 color tokens */
        --md-sys-color-primary: #2a51b3;
        --md-sys-color-on-primary: #ffffff;
        --md-sys-color-primary-container: #eaddff;
        --md-sys-color-on-primary-container: #21005d;
        --md-sys-color-secondary: #757575;
        --md-sys-color-on-secondary: #ffffff;
        --md-sys-color-secondary-container: #e8def8;
        --md-sys-color-on-secondary-container: #1d192b;
        --md-sys-color-hada: #f3e9df;
        --md-sys-color-yellow: #efc800;
        --md-sys-color-red: #e60312;
        --md-sys-color-surface: #fff;
        --md-sys-color-on-surface: #1d1b20;
        --md-sys-color-surface-variant: #ebebeb;
        --md-sys-color-on-surface-variant: #525252;
        --md-sys-color-outline: #79747e;
        --md-sys-color-outline-variant: #cac4d0;
        --md-sys-color-error: #e60312;
        --md-sys-color-on-error: #ffffff;
        --md-sys-color-error-container: #ffdad6;
        --md-sys-color-on-error-container: #410002;

        /* Elevation tokens */
        --md-sys-elevation-level1: 0px 1px 2px 0px rgba(0, 0, 0, 0.3),
          0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        --md-sys-elevation-level2: 0px 1px 2px 0px rgba(0, 0, 0, 0.3),
          0px 2px 6px 2px rgba(0, 0, 0, 0.15);
        --md-sys-elevation-level3: 0px 1px 3px 0px rgba(0, 0, 0, 0.3),
          0px 4px 8px 3px rgba(0, 0, 0, 0.15);

        /* Shape tokens */
        --md-sys-shape-corner-extra-small: 4px;
        --md-sys-shape-corner-small: 8px;
        --md-sys-shape-corner-medium: 12px;
        --md-sys-shape-corner-large: 16px;
        --md-sys-shape-corner-extra-large: 28px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: "Roboto", sans-serif;
        background-color: var(--md-sys-color-yellow);
        color: var(--md-sys-color-on-surface);
      }

      body {
        overflow-y: auto;
        line-height: 1.5;
        padding: 16px;
      }

      .card-like {
        width: 100%;
        min-height: 100vh;
        margin: 0;
        background-color: var(--md-sys-color-surface);
        padding: 24px;
        box-sizing: border-box;
        border-radius: var(--md-sys-shape-corner-large);
        box-shadow: var(--md-sys-elevation-level1);
        max-width: 600px;
        margin: 0 auto;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0 0 32px 0;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
      }

      .brand .logo {
        width: 40px;
        height: 40px;
        display: inline-block;
      }

      .brand strong {
        font-weight: 500;
        font-size: 20px;
        color: var(--md-sys-color-on-surface);
      }

      .section-title {
        font-weight: 500;
        font-size: 22px;
        line-height: 28px;
        color: var(--md-sys-color-on-surface);
        margin: 24px 0 16px 0;
        letter-spacing: 0;
      }

      .seed-title-wrap {
        display: flex;
        align-items: center;
        gap: 16px;
        margin: 24px 0;
      }

      .avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        box-shadow: var(--md-sys-elevation-level1);
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .avatar:hover {
        transform: scale(1.05);
      }

      .field-label {
        font-weight: 500;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.1px;
        color: var(--md-sys-color-on-surface-variant);
        margin-top: 24px;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .field-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
        padding: 12px 16px;
        background-color: var(--md-sys-color-surface-variant);
        border-radius: var(--md-sys-shape-corner-small);
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
      }

      .field-label-2 {
        font-weight: 500;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.1px;
        color: var(--md-sys-color-on-surface-variant);
        min-width: 80px;
        margin-top: 16px;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      /* Content sections */
      #categoryText {
        font-size: 12px;
        font-weight: 500;
        color: var(--md-sys-color-on-surface-variant);
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 8px;
      }

      #titleText {
        font-size: 24px !important;
        font-weight: 500 !important;
        line-height: 32px;
        color: var(--md-sys-color-on-surface);
      }

      #commentText {
        padding: 16px 0;
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
      }

      #kindText {
        padding: 16px;
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
      }

      /* いいね！ */
      .likes-header {
        display: flex;
        align-items: baseline;
        gap: 12px;
        margin: 32px 0 16px 0;
        padding: 0 16px;
      }

      .likes-title {
        font-weight: 500;
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0.5px;
        color: var(--md-sys-color-on-surface);
      }

      .likes-count {
        color: var(--md-sys-color-on-surface-variant);
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.25px;
      }

      .likes-avatars {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 24px;
        padding: 16px;
      }

      .likes-avatars img {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 50%;
        box-shadow: var(--md-sys-elevation-level1);
        transition: transform 0.2s ease;
        cursor: pointer;
      }

      .likes-avatars img:hover {
        transform: scale(1.05);
      }

      .like-btn-row {
        display: flex;
        justify-content: flex-end;
        padding: 16px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 140px;
        height: 40px;
        background-color: var(--md-sys-color-red);
        color: var(--md-sys-color-on-primary);
        border: none;
        border-radius: var(--md-sys-shape-corner-large);
        font-weight: 500;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.1px;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--md-sys-elevation-level1);
        font-family: "Roboto", sans-serif;
      }

      .btn:hover {
        box-shadow: var(--md-sys-elevation-level2);
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: var(--md-sys-elevation-level1);
      }

      .btn[disabled] {
        background-color: var(--md-sys-color-outline-variant);
        color: var(--md-sys-color-on-surface-variant);
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .btn[disabled]:hover {
        box-shadow: none;
        transform: none;
      }

      .btn-secondary {
        background-color: var(--md-sys-color-secondary-container);
        color: var(--md-sys-color-on-secondary-container);
      }

      .btn-liked {
        pointer-events: none;
        opacity: 0.9;
      }

      .hint {
        color: var(--md-sys-color-on-surface-variant);
        font-size: 12px;
        line-height: 16px;
        letter-spacing: 0.4px;
        font-style: italic;
      }

      hr {
        border: none;
        height: 1px;
        background-color: var(--md-sys-color-outline-variant);
        margin: 32px 0;
      }

      #screen2 {
        position: fixed;
        inset: 0;
        z-index: 1200;
        background-color: var(--md-sys-color-hada);
        display: none;
        overflow: auto;
        padding: 16px;
      }

      #screen2 .card-like {
        max-width: 600px;
        width: 100%;
        height: auto;
        min-height: calc(100vh - 32px);
        margin: 0 auto;
        border: 0;
        border-radius: var(--md-sys-shape-corner-large);
        background-color: var(--md-sys-color-surface);
        padding: 24px;
        box-shadow: var(--md-sys-elevation-level1);
      }

      #screen2 .brand {
        position: sticky;
        top: 0;
        background-color: var(--md-sys-color-surface);
        padding-top: 8px;
        z-index: 1;
      }

      /* オーバーレイ／トースト */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        z-index: 3001;
        display: none;
        justify-content: center;
        align-items: center;
      }

      #loadingOverlay.show {
        display: flex;
      }

      .spinner-border {
        width: 48px;
        height: 48px;
        border: 4px solid var(--md-sys-color-outline-variant);
        border-top: 4px solid var(--md-sys-color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #errToast {
        display: none;
        position: fixed;
        left: 50%;
        bottom: 32px;
        transform: translateX(-50%);
        background-color: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
        padding: 16px 24px;
        border-radius: var(--md-sys-shape-corner-small);
        z-index: 4002;
        box-shadow: var(--md-sys-elevation-level3);
        font-weight: 500;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.25px;
        max-width: 90%;
        word-wrap: break-word;
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        body {
          padding: 8px;
        }

        .card-like {
          padding: 16px;
          border-radius: var(--md-sys-shape-corner-medium);
          min-height: calc(100vh - 16px);
        }

        .brand {
          gap: 8px;
          margin-bottom: 24px;
          padding-bottom: 12px;
        }

        .brand .logo {
          width: 32px;
          height: 32px;
        }

        .brand strong {
          font-size: 18px;
        }

        .seed-title-wrap {
          padding: 0;
          gap: 12px;
          margin: 8px 0;
        }

        .avatar {
          width: 48px;
          height: 48px;
        }

        .field-label {
          font-size: 12px;
          margin-top: 20px;
          margin-bottom: 6px;
        }

        .field-row {
          padding: 12px;
          font-size: 14px;
          gap: 8px;
        }

        #titleText {
          font-size: 20px !important;
          line-height: 28px;
        }

        #commentText {
          padding: 12px 0;
          font-size: 14px;
        }

        #kindText {
          padding: 12px;
          font-size: 14px;
        }

        .likes-header {
          margin: 24px 0 12px 0;
          padding: 0 12px;
          gap: 8px;
        }

        .likes-title {
          font-size: 14px;
        }

        .likes-avatars {
          padding: 12px;
          gap: 8px;
          margin-bottom: 20px;
        }

        .likes-avatars img {
          width: 40px;
          height: 40px;
        }

        .like-btn-row {
          padding: 12px;
        }

        .btn {
          min-width: 120px;
          height: 36px;
          font-size: 12px;
          border-radius: var(--md-sys-shape-corner-medium);
        }

        #screen2 {
          padding: 8px;
        }

        #screen2 .card-like {
          padding: 16px;
          border-radius: var(--md-sys-shape-corner-medium);
          min-height: calc(100vh - 16px);
        }
      }

      /* Bottom Navigation Bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        background-color: var(--md-sys-color-surface);
        border-top: 1px solid var(--md-sys-color-outline-variant);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        box-shadow: 0px -2px 8px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--md-sys-color-on-surface-variant);
        padding: 8px;
        border-radius: var(--md-sys-shape-corner-small);
        transition: all 0.2s ease;
        min-width: 64px;
      }

      .nav-item:hover {
        color: var(--md-sys-color-primary);
        background-color: var(--md-sys-color-primary-container);
        text-decoration: none;
      }

      .nav-item.active {
        color: var(--md-sys-color-primary);
        background-color: var(--md-sys-color-hada);
      }

      .nav-item .material-icons-round {
        font-size: 24px;
        margin-bottom: 4px;
      }

      .nav-item span:last-child {
        font-size: 12px;
        font-weight: 500;
        line-height: 16px;
        letter-spacing: 0.4px;
      }

      /* Add bottom padding to body to account for fixed nav */
      body {
        padding-bottom: 80px;
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 88px;
        }
      }
    </style>
    <link rel="stylesheet" href="./profileDspSub.css" />
  </head>
  <body>
    <div class="card-like" id="screen1">
      <div class="brand">
        <img class="logo" src="logo.png" alt="キュリオグラフ2025" />
        <strong>キュリオグラフ2025</strong>
      </div>

      <div class="hint mb-2" id="categoryText">読み込み中・・</div>
      <div id="titleText" style="font-size: 20px; font-weight: 700">
        読み込み中・・
      </div>

      <div class="seed-title-wrap">
        <img id="ownerIcon" class="avatar" src="logo.png" alt="owner" />
        <div id="ownerName">読み込み中・・</div>
      </div>

      <div id="commentText">読み込み中・・</div>

      <div class="field-label">こんな人とMEETUPで話したい</div>
      <div id="kindText">読み込み中・・</div>

      <hr />

      <div class="likes-header">
        <div class="likes-title">いいね！</div>
      </div>

      <div id="likesAvatars" class="likes-avatars"></div>

      <div class="like-btn-row">
        <button id="likeBtn" class="btn like-btn">
          <span class="material-icons-round">favorite_border</span>
          いいね！
        </button>
      </div>
    </div>

    <div id="screen2" style="display: none">
      <div id="profiledsp_common_section_placeholder"></div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay">
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <div id="errToast"><span id="errText"></span></div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
      <a
        href="https://liff.line.me/2008071727-vLPLr6Gx"
        class="nav-item active"
      >
        <span class="material-icons-round">person</span>
        <span>マイページ</span>
      </a>
      <a href="https://liff.line.me/2008071727-JWxnby8r" class="nav-item">
        <span class="material-icons-round">view_list</span>
        <span>タネ一覧</span>
      </a>
      <a
        href="https://liff.line.me/2008071727-ypMm7WGE"
        class="nav-item active"
      >
        <span class="material-icons-round">add_circle</span>
        <span>タネ投稿</span>
      </a>
    </nav>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="./utils.js?ver=1.02"></script>

    <script>
      // ===== 設定 =====
      const LIFF_ID = "2008071727-prQWbK4R";
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzAno1Dw2ikstvC9exjQyYLs3X8K_st48GGXooE8SqqcTuMNq6H_M4jW8E5CDlphN0-cg/exec";
      const DUMMY_ICON_URL = "logo.png";

      const taneId = new URL(location.href).searchParams.get("taneId");
      var rtnData = {};

      let likesProfileMap = {};

      function renderLikes(list) {
        const wrap = document.getElementById("likesAvatars");
        if (!wrap) return;

        wrap.innerHTML = "";
        likesProfileMap = {}; // 毎回作り直し

        (list || []).forEach((x, i) => {
          const img = document.createElement("img");
          const idNum = String(i + 1).padStart(3, "0");
          const domId = `likesAvatar_${idNum}`;

          img.id = domId;
          img.src =
            (x.likeProfile && x.likeProfile.ownerIcon) || DUMMY_ICON_URL;
          img.alt = "like-user";
          wrap.appendChild(img);

          // クリック時に引くためのプロフィールを記録
          likesProfileMap[domId] = x.likeProfile || {};
        });
      }

      function setLiked() {
        const btn = document.getElementById("likeBtn");
        if (!btn) return;
        if (btn.classList.contains("btn-liked")) return; // すでに済なら何もしない
        btn.innerHTML =
          '<span class="material-icons-round">favorite</span>いいね済み';
        btn.disabled = true;
        btn.classList.remove("btn-primary");
        btn.classList.add("btn-secondary", "btn-liked");
      }

      async function loadPage() {
        if (!taneId) {
          toast("taneId がありません");
          return;
        }
        try {
          const idToken = liff.getIDToken();
          const r = await fetch(
            `${GAS_ENDPOINT}?action=tane_public_bundle&taneId=${encodeURIComponent(
              taneId
            )}&id_token=${encodeURIComponent(idToken)}`
          );
          rtnData = r.ok ? await r.json() : { ok: false };
          if (!rtnData.ok || !rtnData.record) {
            toast(rtnData.error || "タネが見つかりません");
            return;
          }

          // 本体表示
          $("#categoryText").text(`カテゴリ：${rtnData.record.category || ""}`);
          $("#titleText").text(rtnData.record.title || "");
          $("#commentText").text(rtnData.record.comment || "");
          $("#kindText").text(rtnData.record.kind_person || "");
          $("#ownerIcon").attr(
            "src",
            (rtnData.ownerProfile && rtnData.ownerProfile.ownerIcon) ||
              DUMMY_ICON_URL
          );
          $("#ownerName").text(
            (rtnData.ownerProfile && rtnData.ownerProfile.name) || ""
          );

          // いいね一覧
          renderLikes(rtnData.likes || []);
          if (rtnData.alreadyLiked) setLiked();

          // クリックでプロフィール詳細（owner単体）
          addListenerProfileDetailSingle(
            "ownerIcon",
            rtnData.ownerProfile || {},
            true,
            true
          );

          // クリックでプロフィール詳細（likes 複数）
          const likeProfiles = (rtnData.likes || []).map(
            (x) => x.likeProfile || {}
          );
          addListenerProfileDetail(likeProfiles, "likesAvatar", true, true);

          $("#profile-like-btn").on("click", profileLikeActionForTaneDsp);
          // 戻るボタン
          addListenerProfileDetailRtnBtn();
        } catch (e) {
          console.error(e);
          toast("読み込みエラーが発生しました");
        }
      }

      function likeAction() {
        const $btn = $("#likeBtn");
        if ($btn.hasClass("btn-liked") || $btn.prop("disabled")) return;

        // ---- 楽観的にUI更新 ----
        // ---- 元の状態を保存（ロールバック用）----
        const prevAlreadyLiked = rtnData.alreadyLiked;
        const prevOwnerProfile = JSON.parse(
          JSON.stringify(rtnData.ownerProfile)
        );
        const prevLikes = JSON.parse(JSON.stringify(rtnData.likes || []));
        const prevMyLike = JSON.parse(JSON.stringify(rtnData.myLike));

        // ---- 楽観的にUI更新 ----
        rtnData.alreadyLiked = true;
        // ownerProfile.likeProfileに追加。二重追加防止（同じ taneId が既に並んでいれば追加しない）
        const existsOwnerProfileTaneId = (
          rtnData.ownerProfile.taneLikeList || []
        ).some((x) => x?.taneId === taneId);
        if (!existsOwnerProfileTaneId) {
          rtnData.ownerProfile.taneLikeList =
            rtnData.ownerProfile.taneLikeList || [];
          rtnData.ownerProfile.taneLikeList.push(rtnData.record);
        }
        // myLike.likeProfileに追加。二重追加防止（同じ taneId が既に並んでいれば追加しない）
        const existsMyLikeTaneId = (
          rtnData.myLike.likeProfile.taneLikeList || []
        ).some((x) => x?.taneId === taneId);
        if (!existsMyLikeTaneId) {
          rtnData.myLike.likeProfile.taneLikeList =
            rtnData.myLike.likeProfile.taneLikeList || [];
          rtnData.myLike.likeProfile.taneLikeList.push(rtnData.record);
        }
        // likes[].likeProfileに追加。二重追加防止（同じ userId が既に並んでいれば追加しない）
        const myUid = rtnData.myLike?.likeProfile?.userId;
        const exists = (rtnData.likes || []).some(
          (x) => x?.likeProfile?.userId === myUid
        );
        rtnData.likes = exists
          ? [...prevLikes]
          : [...prevLikes, rtnData.myLike];

        setLiked(); // ボタンを“いいね済み”に
        renderLikes(rtnData.likes || []);
        const likeProfiles = (rtnData.likes || []).map(
          (x) => x.likeProfile || {}
        );
        addListenerProfileDetail(likeProfiles, "likesAvatar", true, true);

        // ---- 非同期でサーバーへ投げっぱなし ----
        const idt = liff.getIDToken();
        const url = `${GAS_ENDPOINT}?action=like_tane&taneId=${encodeURIComponent(
          taneId
        )}&id_token=${encodeURIComponent(idt)}`;

        fetch(url)
          .then((r) =>
            r.ok ? r.json() : Promise.reject(new Error(`HTTP ${r.status}`))
          )
          .then((j) => {
            if (!j.ok) throw new Error(j.error || "like failed");
            // 成功なら何もしない（すでにUI更新済み）
          })
          .catch((err) => {
            console.error(err);
            toast("いいねに失敗しました");

            // ---- ロールバック ----
            rtnData.ownerProfile = prevOwnerProfile;
            rtnData.alreadyLiked = prevAlreadyLiked;
            rtnData.likes = prevLikes;
            rtnData.myLike = prevMyLike;
            renderLikes(rtnData.likes || []);
            addListenerProfileDetailSingle(
              "ownerIcon",
              rtnData.ownerProfile || {},
              true,
              true
            );
            const likeProfiles2 = (rtnData.likes || []).map(
              (x) => x.likeProfile || {}
            );
            addListenerProfileDetail(likeProfiles2, "likesAvatar", true, true);

            // ボタン表示も元へ
            const btn = document.getElementById("likeBtn");
            if (btn) {
              btn.innerHTML =
                '<span class="material-icons-round">favorite_border</span>いいね！';
              btn.disabled = false;
              btn.classList.remove("btn-secondary", "btn-liked");
              btn.classList.add("like-btn");
            }
          });
      }

      $(async function () {
        try {
          loading.on();
          // 共通部分（プロフィール表示）の読み込み
          const response1 = await fetch("profileDspCommHtml.html");
          const commonSection1 = await response1.text();
          document.getElementById(
            "profiledsp_common_section_placeholder"
          ).innerHTML = commonSection1;
          await waiteCreateDom(PROFILE_DSP_COMM_HTML_DSP_IDS);
          addEventListenerProfileDspTab();

          await liff.init({ liffId: LIFF_ID });
          const ready = await ensureLoginAndScopes();
          if (!ready) return;

          await loadPage();
          $("#likeBtn").on("click", likeAction);
        } catch (e) {
          console.error("LIFF init failed", e);
          toast("LIFFの初期化に失敗しました");
        } finally {
          loading.off(); // 最後に閉じる
        }
      });
    </script>
  </body>
</html>
