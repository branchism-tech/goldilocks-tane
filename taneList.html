<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>みんなのタネ</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f4efe8;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0;
      }
      .brand .logo {
        width: 30px;
        height: 30px;
      }
      .sort-btn,
      .cat-btn {
        margin: 0 4px 8px 0;
      }
      .card-tane {
        margin-bottom: 12px;
      }
      .card-body {
        cursor: pointer;
      }
      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid #aaa;
        object-fit: cover;
      }
      .like-btn {
        min-width: 72px;
      }
      .like-btn[disabled] {
        background: #adb5bd;
        border-color: #adb5bd;
      }
      .liked {
        background: #000 !important;
        border-color: #000 !important;
        color: #fff !important;
      }

      /* オーバーレイ／トースト */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        z-index: 3001;
        display: none;
        justify-content: center;
        align-items: center;
      }

      #loadingOverlay.show {
        display: flex;
      }

      .spinner-border {
        width: 48px;
        height: 48px;
        border: 4px solid var(--md-sys-color-outline-variant);
        border-top: 4px solid var(--md-sys-color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #errToast {
        display: none;
        position: fixed;
        left: 50%;
        bottom: 32px;
        transform: translateX(-50%);
        background-color: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
        padding: 16px 24px;
        border-radius: var(--md-sys-shape-corner-small);
        z-index: 4002;
        box-shadow: var(--md-sys-elevation-level3);
        font-weight: 500;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.25px;
        max-width: 90%;
        word-wrap: break-word;
      }

      /* Desktop adjustments */
      @media (min-width: 768px) {
        .card-like {
          padding: 24px;
          max-width: 600px;
          margin: 0 auto;
          border-radius: var(--md-sys-shape-corner-large);
          box-shadow: var(--md-sys-elevation-level1);
        }
        #errToast {
          bottom: 32px;
          padding: 16px 24px;
          font-size: 14px;
          max-width: 90%;
        }
      }
    </style>
  </head>
  <body class="p-2">
    <div class="container">
      <div class="brand">
        <img class="logo" src="logo.png" alt="ロゴ" />
        <strong>みんなのタネ</strong>
      </div>
      <p>やってみたいことを投稿して、一緒にチャレンジする仲間を見つけよう！</p>

      <div class="mb-2">
        <button class="btn btn-outline-dark cat-btn" data-cat="all">
          全て
        </button>
        <button
          class="btn btn-outline-dark cat-btn"
          data-cat="テーマ①日本橋での表現活動（アート・音楽など自由に！）"
        >
          カテゴリー①
        </button>
        <button
          class="btn btn-outline-dark cat-btn"
          data-cat="テーマ②「あなたオリジナルの日本橋特集マップ」"
        >
          カテゴリー②
        </button>
      </div>

      <div class="mb-2">
        <select
          id="sortSel"
          class="form-control form-control-sm"
          style="width: auto; display: inline-block"
        >
          <option value="likes">いいね数順</option>
          <option value="new">新着順</option>
        </select>
      </div>

      <div id="list" class="row"></div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay">
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
        <span class="sr-only">Loading...</span>
      </div>
    </div>

    <div id="errToast"><span id="errText"></span></div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="./utils.js?ver=1.02"></script>
    <script>
      const LIFF_ID = "2008071727-JWxnby8r";
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzAno1Dw2ikstvC9exjQyYLs3X8K_st48GGXooE8SqqcTuMNq6H_M4jW8E5CDlphN0-cg/exec";
      const DUMMY_ICON_URL = "logo.png";
      let allTanes = [];
      let isLiff = false;

      function toast(msg) {
        $("#errToast").text(msg).fadeIn(200);
        setTimeout(() => $("#errToast").fadeOut(300), 2000);
      }

      function renderList(cat = "all", sort = "likes") {
        let data = [...allTanes];
        if (cat !== "all") {
          data = data.filter((d) => d.category === cat);
        }
        if (sort === "likes") {
          data.sort((a, b) => b.likeCount - a.likeCount);
        } else {
          data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        const wrap = $("#list");
        wrap.empty();
        data.forEach((d) => {
          const card = $(`
          <div class="col-md-4 col-12">
            <div class="card card-tane" data-id="${d.taneId}">
              <div class="card-body">
                <h6>${d.title || ""}</h6>
                <p class="small text-muted">${d.comment || ""}</p>
                <div class="d-flex align-items-center mb-2">
                   <img class="avatar mr-2" src="${
                     d.ownerIcon || DUMMY_ICON_URL
                   }"/>
                  <div>${d.name || "名無し"}</div>
                </div>
                <p class="small text-muted">${d.kind_person || ""}</p>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-sm like-btn ${
                  d.alreadyLiked ? "liked" : ""
                }" data-id="${d.taneId}" ${
            !isLiff || d.alreadyLiked ? "disabled" : ""
          }>
                  ♥ ${d.likeCount}
                </button>
              </div>
            </div>
          </div>
        `);
          // card click -> detail
          card.find(".card-body").on("click", (e) => {
            if ($(e.target).hasClass("like-btn")) return;
            window.location.href = `https://liff.line.me/2008071727-prQWbK4R?taneId=${encodeURIComponent(
              d.taneId
            )}`;
          });
          // like button
          card.find(".like-btn").on("click", () => likeTane(d.taneId));
          wrap.append(card);
        });
      }

      async function fetchTanes() {
        const idt = isLiff ? liff.getIDToken() : "";
        const url = `${GAS_ENDPOINT}?action=tane_list_all&id_token=${encodeURIComponent(
          idt
        )}`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "fail");
        allTanes = j.list;
      }

      async function likeTane(taneId) {
        const btn = $(`.like-btn[data-id="${taneId}"]`);
        btn.prop("disabled", true);
        let tane = allTanes.find((s) => s.taneId === taneId);
        tane.likeCount += 1;
        tane.alreadyLiked = true;
        btn.addClass("liked").text(`♥ ${tane.likeCount}`);
        try {
          const idt = liff.getIDToken();
          const url = `${GAS_ENDPOINT}?action=like_tane&taneId=${encodeURIComponent(
            taneId
          )}&id_token=${encodeURIComponent(idt)}`;
          const r = await fetch(url);
          const j = await r.json();
          if (!j.ok) throw new Error();
        } catch (e) {
          toast("いいね失敗");
        }
      }

      $(async function () {
        try {
          loading.on();
          await liff.init({ liffId: LIFF_ID });
          isLiff = liff.isInClient() || liff.isLoggedIn();
          if (isLiff && !liff.isLoggedIn()) await liff.login();
          try {
            await fetchTanes();
            renderList();
            $(".cat-btn").on("click", function () {
              renderList($(this).data("cat"), $("#sortSel").val());
            });
            $("#sortSel").on("change", function () {
              renderList("all", this.value);
            });
          } catch (e) {
            toast("読み込み失敗");
          }
        } catch (e) {
          console.error("LIFF init failed", e);
          toast("LIFFの初期化に失敗しました");
        } finally {
          loading.off(); // 最後に閉じる
        }
      });
    </script>
  </body>
</html>
