<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>みんなのタネ</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet"
    />
    <style>
      :root {
        /* Material Design 3 color tokens */
        --md-sys-color-primary: #2a51b3;
        --md-sys-color-on-primary: #ffffff;
        --md-sys-color-primary-container:#f9f4ee;
        --md-sys-color-on-primary-container: #21005d;
        --md-sys-color-secondary: #757575;
        --md-sys-color-on-secondary: #ffffff;
        --md-sys-color-secondary-container: #e8def8;
        --md-sys-color-on-secondary-container: #1d192b;
        --md-sys-color-hada: #f3e9df;
        --md-sys-color-yellow: #efc800;
        --md-sys-color-red: #e60312;
        --md-sys-color-orange: #ED0300;
        --md-sys-color-green: #268454;
        --md-sys-color-surface: #fff;
        --md-sys-color-blue: #AFCCD1;
        --md-sys-color-on-surface: #1d1b20;
        --md-sys-color-surface-variant: #ebebeb;
        --md-sys-color-on-surface-variant: #525252;
        --md-sys-color-outline: #79747e;
        --md-sys-color-outline-variant: #cac4d0;
        --md-sys-color-error: #e60312;
        --md-sys-color-on-error: #ffffff;
        --md-sys-color-error-container: #ffdad6;
        --md-sys-color-on-error-container: #410002;

        /* Elevation tokens */
        --md-sys-elevation-level0: 0px 1px 2px 0px rgba(0, 0, 0, 0.2),
          0px 1px 3px 1px rgba(0, 0, 0, 0.10);
        --md-sys-elevation-level1: 0px 1px 2px 0px rgba(0, 0, 0, 0.3),
          0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        --md-sys-elevation-level2: 0px 1px 2px 0px rgba(0, 0, 0, 0.3),
          0px 2px 6px 2px rgba(0, 0, 0, 0.15);
        --md-sys-elevation-level3: 0px 1px 3px 0px rgba(0, 0, 0, 0.3),
          0px 4px 8px 3px rgba(0, 0, 0, 0.15);

        /* Shape tokens */
        --md-sys-shape-corner-extra-small: 4px;
        --md-sys-shape-corner-small: 8px;
        --md-sys-shape-corner-medium: 12px;
        --md-sys-shape-corner-large: 16px;
        --md-sys-shape-corner-extra-large: 28px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: var(--md-sys-color-hada);
        color: var(--md-sys-color-on-surface);
        line-height: 1.5;
        margin: 0;
        padding: 16px;
        padding-bottom: 96px;
      }
      .card-like {
        max-width: 800px;
        margin: 0 auto;
        background-color: var(--md-sys-color-surface);
        border-radius: var(--md-sys-shape-corner-large);
        padding: 24px;
        box-shadow: var(--md-sys-elevation-level1);
        padding-bottom: 100px !important;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0 0 32px 0;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--md-sys-color-outline-variant);
      }
      .brand .logo {
        width: 40px;
        height: 40px;
        display: inline-block;
      }
      .brand strong {
        font-weight: 500;
        font-size: 20px;
        color: var(--md-sys-color-on-surface);
      }
      #list > div{
        padding-bottom: 8px;
      }

      .sort-btn,
      .cat-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 8px;
        border: none;
        border-radius: var(--md-sys-shape-corner-extra-large);
        background-color: var(--md-sys-color-primary);
        color: var(--md-sys-color-surface);
        font-weight: 900;
        font-size: 12px;
        letter-spacing: 0.1px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: "Roboto", sans-serif;
        text-decoration: none;
      }
      .cat-btn:hover {
        background-color: var(--md-sys-color-hada);
        border-color: var(--md-sys-color-on-error-container);
        color: var(--md-sys-color-on-error-container);
      }
      .card-tane {
        margin-bottom: 16px;
        border: none;
        border-radius: var(--md-sys-shape-corner-medium);
        box-shadow: var(--md-sys-elevation-level0);
        background-color: var(--md-sys-color-surface);
        transition: all 0.2s ease;
        cursor: pointer;
        justify-content: space-between;
        height: 100%;
      }
      .card-tane:hover {
        box-shadow: var(--md-sys-elevation-level2);
      }
      .card-body {
        cursor: pointer;
        padding: 16px;
      }
      .card-body h6 {
        font-weight: 900;
        font-size: 16px;
        line-height: 24px;
        color: var(--md-sys-color-on-surface);
        margin: 12px 0 12px 0;
      }
      .card-body p.small {
        font-size: 14px;
        line-height: 20px;
        color: var(--md-sys-color-on-surface-variant);
        margin: 0;
      }
      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 8px;
      }
      .like-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        border-radius: var(--md-sys-shape-corner-extra-large);
        background-color: var(--md-sys-color-red);
        color: var(--md-sys-color-surface);
        font-weight: 500;
        font-size: 14px;
        letter-spacing: 0.4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: "Roboto", sans-serif;
        margin: 4px 16px 16px auto;     
        border: none;
      }
      .like-btn:hover:not(:disabled) {
        background-color: var(--md-sys-color-primary-container);
      }
      .like-btn[disabled] {
        background-color: var(--md-sys-color-outline);
        color: var(--md-sys-color-surface) !important;
        cursor: not-allowed;
        border: none;
      }
      .liked {
        border: none;
        background-color: var(--md-sys-color-outline) !important;
        color: var(--md-sys-color-surface) !important;
      }

      /* オーバーレイ／トースト */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        z-index: 3001;
        display: none;
        justify-content: center;
        align-items: center;
      }

      #loadingOverlay.show {
        display: flex;
      }

      .spinner-border {
        width: 48px;
        height: 48px;
        border: 4px solid var(--md-sys-color-yellow);
        border-top: 4px solid var(--md-sys-color-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #errToast {
        display: none;
        position: fixed;
        left: 50%;
        bottom: 32px;
        transform: translateX(-50%);
        background-color: var(--md-sys-color-error-container);
        color: var(--md-sys-color-on-error-container);
        padding: 16px 24px;
        border-radius: var(--md-sys-shape-corner-small);
        z-index: 4002;
        box-shadow: var(--md-sys-elevation-level3);
        font-weight: 500;
        font-size: 14px;
        line-height: 20px;
        letter-spacing: 0.25px;
        max-width: 90%;
        word-wrap: break-word;
      }

      .text-xsmall {
        font-size: 12px;
        line-height: 16px;
        color:var(--md-sys-color-on-surface);
        font-weight: 500;
        letter-spacing: 0.4px;
        margin-bottom: 4px;
        padding: 8px 16px;
        background-color:#efefef;
        border-radius: var(--md-sys-shape-corner-extra-large);
      }

      /* Form control styling */
      .form-control {
        background-color: var(--md-sys-color-yellow) !important;
        border: none;
        border-radius: var(--md-sys-shape-corner-extra-large);
        font-size: 12px;
        color: var(--md-sys-color-surface);
        transition: all 0.2s ease;
        font-family: "Roboto", sans-serif;
        padding: 4px 8px;
        font-weight: 900;
        cursor: pointer;
      }

      .form-control:focus,.form-control:hover {
        background-color: var(--md-sys-color-blue) !important;
        color: var(--md-sys-color-on-surface) !important;
      }

      /* Description text styling */
      .card-like > p {
        font-size: 14px;
        line-height: 20px;
        color: var(--md-sys-color-on-surface-variant);
        margin-bottom: 24px;
      }

      /* Desktop adjustments */
      @media (min-width: 768px) {
        body {
          padding: 16px;
          padding-bottom: 96px;
        }
        .card-like {
          padding: 24px;
          max-width: 800px;
          border-radius: var(--md-sys-shape-corner-large);
        }
        #errToast {
          bottom: 32px;
          padding: 16px 24px;
          font-size: 14px;
          max-width: 90%;
        }
      }

      /* Mobile adjustments */
      @media (max-width: 767px) {
        body {
          padding: 8px 8px 88px 8px;
        }
        .card-like {
          padding: 16px;
          border-radius: var(--md-sys-shape-corner-medium);
        }
        .brand {
          gap: 8px;
          margin-bottom: 24px;
          padding-bottom: 12px;
        }
        .brand .logo {
          width: 32px;
          height: 32px;
        }
        .brand strong {
          font-size: 18px;
        }
      }

      /* Bottom Navigation Bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--md-sys-color-surface);
        border-top: 1px solid var(--md-sys-color-outline-variant);
        display: flex;
        justify-content: space-around;
        align-items: stretch;
        z-index: 1000;
        box-shadow: 0px -2px 8px rgba(0, 0, 0, 0.1);
        padding: 4px;
      }

      .bottom-nav.hidden {
        display: none;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: var(--md-sys-color-on-surface-variant);
        padding: 4px 8px;
        border-radius: var(--md-sys-shape-corner-small);
        transition: all 0.2s ease;
        min-width: 25%;
      }

      .nav-item:hover {
        color: var(--md-sys-color-on-primary-container);
        background-color: var(--md-sys-color-yellow);
        text-decoration: none;
      }

      .nav-item.active {
        color: var(--md-sys-color-surface);
        background-color: var(--md-sys-color-green);
      }

      .nav-item .material-icons-round {
        font-size: 18px;
        margin-bottom: 2px;
      }

      .nav-item span:last-child {
        font-size: 8px;
        font-weight: 500;
        line-height: 10px;
        letter-spacing: 0.4px;
      }
    </style>
  </head>
  <body><script
  src="https://js.sentry-cdn.com/fa3cc6e69226d871d4beefa6fc73865d.min.js"
  crossorigin="anonymous"
></script>
    <div class="card-like">
      <div class="brand">
        <img class="logo" src="logo.png" alt="ロゴ" />
        <strong>みんなのタネ</strong>
      </div>
      <p>やってみたいことを投稿して、一緒にチャレンジする仲間を見つけよう！</p>

      <div class="mb-2">
        <button class="cat-btn" data-cat="all">
          全て
        </button>
        <button
          class="cat-btn"
          data-cat="テーマ①日本橋での表現活動（アート・音楽など自由に！）"
        >
          テーマ①
        </button>
        <button
          class="cat-btn"
          data-cat="テーマ②「あなたオリジナルの日本橋特集マップ」"
        >
          テーマ②
        </button>
        <button
          class="cat-btn"
          data-cat="テーマ③その他"
        >
          テーマ③
        </button>
      </div>

      <div class="mb-2">
        <select
          id="sortSel"
          class="form-control"
          style="width: auto; display: inline-block"
        >
          <option value="reco" selected>▼ おすすめ数順 💁</option>
          <option value="likes">▼ いいね数順 ♡</option>
          <option value="new">▼ 新着順 🆕</option>
        </select>
      </div>

      <div id="list" class="row"></div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay">
      <div
        class="spinner-border text-primary"
        role="status"
        style="width: 3rem; height: 3rem"
      >
      </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
      <a
        href="https://liff.line.me/2008071727-vLPLr6Gx"
        class="nav-item"
      >
        <span class="material-icons-round">person</span>
        <span>マイページ</span>
      </a>
      <a href="https://liff.line.me/2008071727-JWxnby8r" class="nav-item active">
        <span class="material-icons-round">view_list</span>
        <span>タネ一覧</span>
      </a>
      <a href="https://liff.line.me/2008071727-ypMm7WGE" class="nav-item">
        <span class="material-icons-round">add_circle</span>
        <span>タネ投稿</span>
      </a>
    </nav>

    <div id="errToast"><span id="errText"></span></div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.27.2/sdk.js"></script>
    <script src="./utils.js?ver=1.02"></script>
    <script>
      const LIFF_ID = "2008071727-JWxnby8r";
      const GAS_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbzAno1Dw2ikstvC9exjQyYLs3X8K_st48GGXooE8SqqcTuMNq6H_M4jW8E5CDlphN0-cg/exec";
      const DUMMY_ICON_URL = "logo.png";
      let allTanes = [];
      let isLiff = false;

      function toast(msg) {
        $("#errToast").text(msg).fadeIn(200);
        setTimeout(() => $("#errToast").fadeOut(300), 2000);
      }

      function renderList(cat = "all", sort = "reco") {
        let data = [...allTanes];
        if (cat !== "all") {
          data = data.filter((d) => d.category === cat);
        }
        if (sort === "reco") {
          data.sort((a, b) => {
            const recoDiff = (Number(b.reco) || 0) - (Number(a.reco) || 0);
            if (recoDiff !== 0) {
              return recoDiff;
            }
            return new Date(b.createdAt) - new Date(a.createdAt);
          });
        } else if (sort === "likes") {
          data.sort((a, b) => {
            const likeDiff =
              (Number(b.likeCount) || 0) - (Number(a.likeCount) || 0);
            if (likeDiff !== 0) {
              return likeDiff;
            }
            return new Date(b.createdAt) - new Date(a.createdAt);
          });
        } else {
          data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        }

        const wrap = $("#list");
        wrap.empty();
        data.forEach((d) => {
          const card = $(`
          <div class="col-md-6 col-12">
            <div class="card card-tane" data-id="${d.taneId}">
              <div class="card-body">
                <p class="text-xsmall">${d.category || ""}</p>
                <h6>${d.title || ""}</h6>
                <div class="d-flex align-items-center mb-3">
                  <img class="avatar" src="${
                    d.ownerIcon || DUMMY_ICON_URL
                  }"/>
                  <div style="font-size: 14px; color: var(--md-sys-color-on-surface);">${d.name || "名無し"}</div>
                </div>
                <p class="small">${d.comment || ""}</p>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <button class="like-btn ${
                  d.alreadyLiked ? "liked" : ""
                }" data-id="${d.taneId}" ${
            !isLiff || d.alreadyLiked ? "disabled" : ""
          }>
                  ♥ ${d.likeCount}
                </button>
              </div>
            </div>
          </div>
        `);
          // card click -> detail
          card.find(".card-body").on("click", (e) => {
            if ($(e.target).hasClass("like-btn")) return;
            window.location.href = `https://liff.line.me/2008071727-prQWbK4R?taneId=${encodeURIComponent(
              d.taneId
            )}`;
          });
          // like button
          card.find(".like-btn").on("click", () => likeTane(d.taneId));
          wrap.append(card);
        });
      }

      async function fetchTanes() {
        const idt = isLiff ? liff.getIDToken() : "";
        const url = `${GAS_ENDPOINT}?action=tane_list_all&id_token=${encodeURIComponent(
          idt
        )}`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "fail");
        allTanes = j.list;
      }

      async function likeTane(taneId) {
        try {
          const idt = liff.getIDToken();
          const url = `${GAS_ENDPOINT}?action=like_tane&taneId=${encodeURIComponent(
            taneId
          )}&id_token=${encodeURIComponent(idt)}`;
          const btn = $(`.like-btn[data-id="${taneId}"]`);
          btn.prop("disabled", true);
          let tane = allTanes.find((s) => s.taneId === taneId);
          tane.likeCount += 1;
          tane.alreadyLiked = true;
          btn.addClass("liked").text(`♥ ${tane.likeCount}`);

          fetch(url)
            .then((r) =>
              r.ok ? r.json() : Promise.reject(new Error(`HTTP ${r.status}`))
            )
            .then((j) => {
              if (!j.ok) throw new Error(j.error || "like failed");
              // 成功なら何もしない（すでにUI更新済み）
            })
            .catch((err) => {
              console.error(err);
              toast("いいねに失敗しました");
              // ---- ロールバック ----
              tane.likeCount -= 1;
              tane.alreadyLiked = false;
              btn.addClass("liked").text(`♥ ${tane.likeCount}`);
            });
        } catch (e) {
          toast("いいねに失敗しました");
        }
      }

      $(async function () {
        try {
          loading.on();
          await liff.init({ liffId: LIFF_ID });
          isLiff = liff.isInClient() || liff.isLoggedIn();
          if (isLiff && !liff.isLoggedIn()) await liff.login();
          
          // LIFFではない場合はナビゲーションバーを非表示
          if (!isLiff) {
            $(".bottom-nav").addClass("hidden");
          }
          
          try {
            await fetchTanes();
            renderList();
            $(".cat-btn").on("click", function () {
              renderList($(this).data("cat"), $("#sortSel").val());
            });
            $("#sortSel").on("change", function () {
              renderList($("sortSel").data("cat"), this.value);
            });
          } catch (e) {
            toast("読み込み失敗");
          }
        } catch (e) {
          console.error("LIFF init failed", e);
          toast("LIFFの初期化に失敗しました");
        } finally {
          loading.off(); // 最後に閉じる
        }
      });
    </script>
  </body>
</html>
